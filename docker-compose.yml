# Docker Compose configuration for Label Studio with Audio Analysis ML Backend
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose logs -f            # View all logs
#   docker compose down               # Stop all services

services:
  # ==========================================================================
  # LABEL STUDIO - Main Annotation Platform
  # ==========================================================================
  label-studio:
    image: heartexlabs/label-studio:20250905.135957-develop-52999f9
    container_name: label-studio
    restart: unless-stopped
    ports:
      - "${LABEL_STUDIO_PORT:-8080}:8080"
    environment:
      - DJANGO_DB=default
      - POSTGRE_NAME=labelstudio
      - POSTGRE_USER=labelstudio
      - POSTGRE_PASSWORD=${POSTGRES_PASSWORD:-labelstudio_secure_password}
      - POSTGRE_HOST=postgres
      - POSTGRE_PORT=5432
      - LABEL_STUDIO_LOCAL_FILES_SERVING_ENABLED=true
      - LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/label-studio/data/files
      - ML_BACKENDS=default:http://labelstudio-audio-api:9090
      - LABEL_STUDIO_DISABLE_SIGNUP_WITHOUT_LINK=false
      - LABEL_STUDIO_USERNAME=${LABEL_STUDIO_USERNAME:-admin@admin.com}
      - LABEL_STUDIO_PASSWORD=${LABEL_STUDIO_PASSWORD:-admin123}
    volumes:
      - labelstudio_data:/label-studio/data
      - labelstudio_files:/label-studio/data/files
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - audio-analysis-network

  # ==========================================================================
  # POSTGRESQL - Database for Label Studio
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: labelstudio-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=labelstudio
      - POSTGRES_USER=labelstudio
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-labelstudio_secure_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U labelstudio -d labelstudio"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - audio-analysis-network

  # ==========================================================================
  # ML BACKEND - Audio Analysis Prediction API
  # ==========================================================================
  labelstudio-audio-api:
    image: labelstudio-audio-api:latest
    container_name: labelstudio-audio-api
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${API_PORT:-9090}:9090"
    volumes:
      - ./logs:/var/log/app
      - audio_data:/app/data
      - labelstudio_files:/label-studio/files:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - audio-analysis-network

  # ==========================================================================
  # BACKUP SERVICE
  # ==========================================================================
  backup-service:
    image: alpine:latest
    container_name: labelstudio-backup
    restart: unless-stopped
    user: root
    volumes:
      - labelstudio_data:/data/labelstudio_data:ro
      - labelstudio_files:/data/labelstudio_files:ro
      - postgres_data:/data/postgres_data:ro
      - audio_data:/data/audio_data:ro
      - ./logs:/data/logs:ro
      - backup_data:/backups
      - ./scripts/backup.sh:/backup.sh:ro
    environment:
      - TZ=UTC
      - BACKUP_RETENTION_DAYS=3
    command: >
      sh -c "apk add --no-cache zip tzdata busybox-suid &&
             echo '0 0 * * * /backup.sh >> /backups/backup.log 2>&1' > /etc/crontabs/root &&
             chmod 600 /etc/crontabs/root &&
             crond -f -l 2"
    depends_on:
      - postgres
      - label-studio
    networks:
      - audio-analysis-network

networks:
  audio-analysis-network:
    driver: bridge
    name: audio-analysis-network

volumes:
  labelstudio_data:
    driver: local
    name: labelstudio-data
  labelstudio_files:
    driver: local
    name: labelstudio-files
  postgres_data:
    driver: local
    name: labelstudio-postgres-data
  audio_data:
    driver: local
    name: audio-analysis-data
  backup_data:
    driver: local
    name: audio-analysis-backups
